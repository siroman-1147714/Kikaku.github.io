<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF8">
    <title>ç«¶é¦¬äºˆæƒ³ã‚µã‚¤ãƒˆ</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

    <style>
        /* ------------------------------------- */
        /* â˜…â˜…â˜… ãƒ¢ãƒ€ãƒ³UIã®ãŸã‚ã®æ”¹å–„ç‰ˆCSS â˜…â˜…â˜… */
        /* ------------------------------------- */

        /* æ—¢å­˜ã®å¿…é ˆã‚¹ã‚¿ã‚¤ãƒ« */
        .hidden { display: none; }
        .horse-label.hidden, .horse-input.hidden { display: none; }

        /* 1. åŸºæœ¬è¨­å®šï¼ˆãƒ•ã‚©ãƒ³ãƒˆã¨èƒŒæ™¯ï¼‰*/
        body {
            /* ãƒ¢ãƒ€ãƒ³ãªãƒ•ã‚©ãƒ³ãƒˆã‚’æŒ‡å®š */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f4f7f6; /* å°‘ã—è‰²ãŒã¤ã„ãŸèƒŒæ™¯ */
            color: #333;
            margin: 0;
            padding: 20px;
        }

        /* 2. å„ç”»é¢ã‚’ã€Œã‚«ãƒ¼ãƒ‰ã€åŒ– */
        #login-screen, #team-view, #host-view, #betting-view, 
        #race-menu-view, #payout-view, #bet-results-view, #final-results-view {
            max-width: 960px;
            margin: 20px auto;
            padding: 25px;
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); /* æŸ”ã‚‰ã‹ã„å½± */
            border: 1px solid #e0e0e0;
        }

        /* 3. è¦‹å‡ºã— (h1, h2, h3) */
        h1, h2 {
            color: #1a237e; /* ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ï¼ˆæ¿ƒã„é’ï¼‰ */
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
            margin-top: 0;
        }
        h3 {
            color: #3949ab; /* ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ï¼ˆå°‘ã—è–„ã„é’ï¼‰ */
        }

        /* 4. æ°´å¹³ç·š (hr) ã‚’æŸ”ã‚‰ã‹ã */
        hr {
            border: 0;
            border-top: 1px solid #eee;
            margin: 25px 0;
        }

        /* 5. ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤ºãƒ˜ãƒƒãƒ€ãƒ¼ */
        .points-display-header {
            background-color: #e8eaf6; /* è–„ã„é’ç´« */
            color: #1a237e;
            text-align: right;
            border-bottom: none;
            padding: 15px;
            margin-top: -10px;
            margin-bottom: 20px;
            border-radius: 5px;
            font-size: 1.1em;
        }
        .points-display-header span {
            font-weight: bold;
            font-size: 1.2em;
        }

        /* 6. çµ±ä¸€ã•ã‚ŒãŸãƒœã‚¿ãƒ³ãƒ‡ã‚¶ã‚¤ãƒ³ */
        button {
            font-size: 1em;
            padding: 10px 15px;
            margin: 4px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: #3949ab; /* ãƒ¡ã‚¤ãƒ³ã®é’ */
            color: white;
            transition: background-color 0.2s ease, transform 0.1s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        button:hover {
            background-color: #283593; /* å°‘ã—æ¿ƒã */
            transform: translateY(-1px); /* ãƒ›ãƒãƒ¼æ™‚ã«å°‘ã—æµ®ãä¸ŠãŒã‚‹ */
        }
        button:active {
            transform: translateY(0);
        }
        
        /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã®ãƒœã‚¿ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’èª¿æ•´ */
        #team-select-wrapper {
            display: flex;
            flex-wrap: wrap; /* ç”»é¢ãŒç‹­ãã¦ã‚‚æŠ˜ã‚Šè¿”ã™ */
            justify-content: center; /* ä¸­å¤®æƒãˆ */
            gap: 15px; /* ãƒœã‚¿ãƒ³é–“ã®éš™é–“ */
            margin: 25px 0; /* ä¸Šä¸‹ã®ãƒãƒ¼ã‚¸ãƒ³ */
        }

        /* 7. ç‰¹å®šã®ãƒœã‚¿ãƒ³ã®èª¿æ•´ */
        
        /* ãƒãƒ¼ãƒ é¸æŠãƒœã‚¿ãƒ³ */
        button.team-select { 
            font-size: 1.2em; /* æ–‡å­—ã‚’å¤§ãã */
            font-weight: bold;
            padding: 20px 30px; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å¤§ãã */
            min-width: 200px; /* æœ€å°å¹…ã‚’æŒ‡å®š */
            flex-grow: 1; /* ã§ãã‚‹ã ã‘å¹…ã‚’åºƒã’ã‚‹ */
            flex-basis: 40%; /* 2åˆ—ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’åŸºæœ¬ã«ã™ã‚‹ */
        }
        button.team-select[data-team="Red"] { background-color: #e53935; }
        button.team-select[data-team="Green"] { background-color: #43a047; }
        button.team-select[data-team="Blue"] { background-color: #1e88e5; }
        
        button.team-select[data-team="Yellow"] { background-color: #fbc02d; color: #333;}
        
        button.team-select:hover { opacity: 0.85; }

        /* ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒ»æˆ»ã‚‹ãƒœã‚¿ãƒ³ (ç›®ç«‹ãŸãªã„è‰²ã«) */
        #team-logout, #host-logout, #back-to-team-menu, #back-to-race-menu,
        #back-to-race-menu-from-payout, #back-to-race-menu-from-results,
        #back-to-team-menu-from-final {
            background-color: #78909c; /* ã‚°ãƒ¬ãƒ¼ */
        }
        #team-logout:hover, #host-logout:hover, #back-to-team-menu:hover, 
        #back-to-race-menu:hover, #back-to-race-menu-from-payout:hover, 
        #back-to-race-menu-from-results:hover, #back-to-team-menu-from-final:hover {
            background-color: #546e7a;
        }

        /* é‡è¦ãªè³¼å…¥ãƒœã‚¿ãƒ³ */
        #purchase-all-button {
            background-color: #43a047; /* ç·‘ */
            font-size: 1.2em !important; /* æ—¢å­˜ã®styleã‚’ä¸Šæ›¸ã */
        }
        #purchase-all-button:hover { background-color: #2e7d32; }

        /* å±é™ºãªãƒªã‚»ãƒƒãƒˆãƒ»å®Ÿè¡Œãƒœã‚¿ãƒ³ */
        #reset-bets-button, #reset-results-button, #execute-payout-button {
            background-color: #d32f2f !important; /* æ¿ƒã„èµ¤ */
            color: white;
        }
        #reset-bets-button:hover, #reset-results-button:hover, #execute-payout-button:hover {
            background-color: #b71c1c !important;
        }

        /* 8. ãƒ•ã‚©ãƒ¼ãƒ è¦ç´  (input, select) */
        input[type="number"], input[type="text"], select {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1em;
            margin: 5px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        input[type="number"]:focus, input[type="text"]:focus, select:focus {
            border-color: #3949ab;
            box-shadow: 0 0 0 2px rgba(57, 73, 171, 0.2);
            outline: none;
        }
        
        /* betting-form ã¯ JavaScript ã§ãƒ­ãƒƒã‚¯/è§£é™¤ã‚’åˆ¶å¾¡ */

        /* 9. ãƒªã‚¹ãƒˆã¨ã‚«ãƒ¼ãƒˆ */
        #cart, #team-bet-list, #host-bet-list, #race-menu-bet-list, #betting-view-bet-list {
            border: 1px solid #e0e0e0;
            padding: 10px;
            min-height: 50px;
            height: 150px; /* æ—¢å­˜ã®æŒ‡å®šã‚’ç¶­æŒ */
            overflow-y: auto;
            margin-bottom: 10px;
            background: #ffffff;
            border-radius: 5px;
        }
        #cart { background: #fdfdfd; } /* ã‚«ãƒ¼ãƒˆã¯å°‘ã—è‰²ã‚’å¤‰ãˆã‚‹ */

        #cart .cart-item, .bet-history-item {
            border-bottom: 1px solid #eee;
            padding: 8px 5px;
            margin: 0; /* æ—¢å­˜ã®marginã‚’ãƒªã‚»ãƒƒãƒˆ */
        }
        #cart .cart-item:last-child, .bet-history-item:last-child {
            border-bottom: none;
        }

        /* ã‚«ãƒ¼ãƒˆã®å‰Šé™¤ãƒœã‚¿ãƒ³ */
        .remove-cart-item {
            background-color: #ef5350; /* èµ¤ç³» */
            color: white;
            padding: 2px 8px;
            font-size: 0.8em;
            margin-left: 5px;
        }
        .remove-cart-item:hover { background-color: #d32f2f; }

        /* è³¼å…¥å±¥æ­´ã®å–ã‚Šæ¶ˆã—ãƒœã‚¿ãƒ³ */
        .cancel-bet-button {
            background-color: #ffcdd2; /* è–„ã„èµ¤ */
            border: 1px solid #e53935 !important;
            color: #c62828;
            margin-left: 5px;
            font-size: 0.8em !important;
            padding: 2px 8px;
        }
        .cancel-bet-button:hover {
            background-color: #ef9a9a;
        }

        /* 10. ãƒ¬ãƒ¼ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
        .race-status { font-weight: bold; margin-left: 10px; }
        .status-open { color: #43a047; }
        .status-closed { color: #e53935; }
        
        #betting-status-message-wrapper {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        #betting-status-message-wrapper p {
            margin: 0;
            font-size: 1.1em;
            text-align: center;
        }
        #betting-status-message-wrapper.locked {
            background-color: #ffebee; /* è–„ã„èµ¤ */
        }
        #betting-status-message-wrapper.unlocked {
            background-color: #e8f5e9; /* è–„ã„ç·‘ */
        }
        
        /* ãƒ•ã‚©ãƒ¼ãƒ ç„¡åŠ¹åŒ–æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #betting-form.locked, #cart-wrapper.locked {
            opacity: 0.6;
            pointer-events: none; /* ã‚¯ãƒªãƒƒã‚¯è‡ªä½“ã‚’ç„¡åŠ¹åŒ– */
        }

        /* 11. çµæœãƒ†ãƒ¼ãƒ–ãƒ« */
        .results-table {
            border-collapse: collapse;
            width: 100%; /* å¹…ã‚’åºƒã’ã‚‹ */
            margin-top: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border-radius: 5px;
            overflow: hidden; /* è§’ä¸¸ã‚’åŠ¹ã‹ã›ã‚‹ãŸã‚ */
        }
        .results-table th, .results-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        .results-table th {
            background-color: #f5f5f5;
            color: #555;
        }
        .winner-bet {
            background-color: #e8f5e9; /* è–„ã„ç·‘ */
            font-weight: bold;
        }
        .winner-bet td {
            color: #2e7d32;
        }

        /* 12. æœ€çµ‚çµæœãƒœã‚¿ãƒ³ */
        .final-results-button-wrapper {
            position: fixed;
            bottom: 20px; /* å°‘ã—é›¢ã™ */
            right: 20px;
            padding: 0; /* ãƒœã‚¿ãƒ³è‡ªä½“ã«ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ãŒã‚ã‚‹ã®ã§ä¸è¦ */
            background-color: transparent; /* èƒŒæ™¯ãªã— */
            border: none;
            border-radius: 50px; /* ãƒœã‚¿ãƒ³ã‚’ä¸¸ãã™ã‚‹ */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        #goto-final-results-btn {
            background: #ffc107 !important; /* ç›®ç«‹ã¤é»„è‰² */
            color: #333;
            font-size: 1.1em !important;
            border-radius: 50px;
            padding: 15px 25px;
        }
        #goto-final-results-btn:hover {
            background: #ffb300 !important;
        }

        /* 13. æœ€çµ‚çµæœãƒ©ãƒ³ã‚­ãƒ³ã‚° */
        #final-ranking-table tr.rank-1 { background-color: #fff9c4; /* 1ä½: è–„ã„é‡‘ */ }
        #final-ranking-table tr.rank-2 { background-color: #f5f5f5; /* 2ä½: è–„ã„éŠ€ */ }
        #final-ranking-table tr.rank-3 { background-color: #fbe9e7; /* 3ä½: è–„ã„éŠ… */ }

        #final-ranking-table tr.rank-1 td:first-child { font-weight: bold; color: #f57f17; }
        #final-ranking-table tr.rank-2 td:first-child { font-weight: bold; color: #616161; }
        #final-ranking-table tr.rank-3 td:first-child { font-weight: bold; color: #a1887f; }

        /* 14. ãƒ›ã‚¹ãƒˆãƒ‘ãƒãƒ« */
        #host-view table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        #host-view table th, #host-view table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }
        #host-view table th { background-color: #f5f5f5; }
        #host-view table tr:nth-child(even) { background-color: #fafafa; }

        #payout-form {
            border: 2px solid #c62828 !important;
            padding: 15px !important;
            background: #ffebee !important; /* è–„ã„èµ¤ */
            border-radius: 5px;
        }
    </style>
</head>
<body>
    
    <div id="login-screen">
        <h1>ä»®æƒ³ç«¶é¦¬ã‚µã‚¤ãƒˆã¸ã‚ˆã†ã“ã</h1>
        <h2>ãƒãƒ¼ãƒ ã¾ãŸã¯å½¹å‰²ã‚’é¸æŠã—ã¦ãã ã•ã„</h2>

        <div id="team-select-wrapper">
            <button class="team-select" data-team="Red">Team Red</button>
            <button class="team-select" data-team="Green">Team Green</button>
            <button class="team-select" data-team="Blue">Team Blue</button>
            <button class="team-select" data-team="Yellow">Team Yellow</button>
        </div>

        <hr>
        <button id="host-login">ç®¡ç†è€…(Host)ç”¨</button>
    </div>

    <div id="team-view" class="hidden">
        <h2 class="points-display-header">ç¾åœ¨ã®ãƒã‚¤ãƒ³ãƒˆ: <span class="team-points-display">...</span> pt</h2>
        <h1 id="team-header">ã‚ˆã†ã“ã, Team [TBD]</h1>
        <button id="team-logout">ãƒãƒ¼ãƒ é¸æŠã«æˆ»ã‚‹</button>
        <hr>
        
        <h2>ãƒ¬ãƒ¼ã‚¹ä¸€è¦§</h2>
        
        <div id="race-0-wrapper" class="hidden">
            <button class="race-select-btn" data-race="ãƒ¬ãƒ¼ã‚¹0">ãƒ¬ãƒ¼ã‚¹0</button>
            <span id="race-status-0" class="race-status status-closed">ï¼ˆå—ä»˜çµ‚äº†ï¼‰</span>
        </div>
        
        <div id="race-1-wrapper" class="hidden">
            <button class="race-select-btn" data-race="ãƒ¬ãƒ¼ã‚¹1">ãƒ¬ãƒ¼ã‚¹1</button>
            <span id="race-status-1" class="race-status status-closed">ï¼ˆå—ä»˜çµ‚äº†ï¼‰</span>
        </div>
        <div id="race-2-wrapper" class="hidden">
            <button class="race-select-btn" data-race="ãƒ¬ãƒ¼ã‚¹2">ãƒ¬ãƒ¼ã‚¹2</button>
            <span id="race-status-2" class="race-status status-closed">ï¼ˆå—ä»˜çµ‚äº†ï¼‰</span>
        </div>
        <div id="race-3-wrapper" class="hidden">
            <button class="race-select-btn" data-race="ãƒ¬ãƒ¼ã‚¹3">ãƒ¬ãƒ¼ã‚¹3</button>
            <span id="race-status-3" class="race-status status-closed">ï¼ˆå—ä»˜çµ‚äº†ï¼‰</span>
        </div>
        <hr>
    </div>

    <div id="race-menu-view" class="hidden">
        <h2 class="points-display-header">ç¾åœ¨ã®ãƒã‚¤ãƒ³ãƒˆ: <span class="team-points-display">...</span> pt</h2>
        <h1 id="race-menu-header"></h1>
        <button id="back-to-team-menu">ãƒ¬ãƒ¼ã‚¹ä¸€è¦§ã«æˆ»ã‚‹</button>
        <hr>
        <h3>ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h3>
        <button id="download-pdf-btn">ãƒ¬ãƒ¼ã‚¹æƒ…å ± (PDF)</button>
        <button id="download-csv-btn">å‡ºèµ°é¦¬æƒ…å ± (CSV)</button>
        <button id="goto-betting-btn">é¦¬åˆ¸è³¼å…¥</button>
        <button id="show-payouts-btn">é…å½“</button>
        <button id="show-bet-results-btn">æ‰•ã„æˆ»ã—ä¸€è¦§</button>
        <hr>
        <h3>è‡ªãƒãƒ¼ãƒ ã®è³¼å…¥å±¥æ­´ (ã“ã®ãƒ¬ãƒ¼ã‚¹)</h3>
        <p>ï¼ˆè³¼å…¥æ¸ˆã¿é¦¬åˆ¸: <span id="race-menu-bet-count">0</span> / 5 ä»¶ï¼‰</p>
        <div id="race-menu-bet-list"></div>
    </div>

    <div id="betting-view" class="hidden">
        <h2 class="points-display-header">ç¾åœ¨ã®ãƒã‚¤ãƒ³ãƒˆ: <span class="team-points-display">...</span> pt</h2>
        <h1 id="betting-header"></h1>
        
        <div id="betting-status-message-wrapper">
            <p id="betting-status-message" class="race-status status-open">ï¼ˆç¾åœ¨ã€é¦¬åˆ¸ã®è³¼å…¥ãƒ»å–ã‚Šæ¶ˆã—ãŒå¯èƒ½ã§ã™ï¼‰</p>
        </div>
        
        <button id="back-to-race-menu">ãƒ¬ãƒ¼ã‚¹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
        <hr>
        
        <div style="display: flex; gap: 20px;">
            <div style="flex: 1;">
                <h3>é¦¬åˆ¸ã‚’ã‚«ãƒ¼ãƒˆã«è¿½åŠ </h3>
                <div style="border: 1px solid #ddd; border-radius: 5px; padding: 15px; background: #fafafa;">
                    <div id="betting-form"> 
                        <div>
                            <label>é¦¬åˆ¸ã®ç¨®é¡:</label>
                            <select id="bet-type-select">
                                <option value="Tansho">å˜å‹ (1é ­)</option>
                                <option value="Nirentan">äºŒé€£å˜ (2é ­)</option>
                                <option value="Nirenfuku">äºŒé€£è¤‡ (2é ­)</option>
                                <option value="Sanrenpuku">ä¸‰é€£è¤‡ (3é ­)</option>
                                <option value="Sanrentan">ä¸‰é€£å˜ (3é ­)</option>
                            </select>
                        </div>
                        <div id="horse-inputs">
                            <label class="horse-label" id="horse-label-1">é¦¬1:</label>
                            <input type="number" class="horse-input" id="horse-input-1" min="1" max="16">
                            <label class="horse-label hidden" id="horse-label-2">é¦¬2:</label>
                            <input type="number" class="horse-input hidden" id="horse-input-2" min="1" max="16">
                            <label class="horse-label hidden" id="horse-label-3">é¦¬3:</label>
                            <input type="number" class="horse-input hidden" id="horse-input-3" min="1" max="16">
                        </div>
                        <div>
                            <label>è³¼å…¥ãƒã‚¤ãƒ³ãƒˆ:</label>
                            <input type="number" id="bet-amount-input" min="10">
                            <span>pt</span>
                        </div>
                        <button id="add-to-cart-button">ã‚«ãƒ¼ãƒˆã«è¿½åŠ </button>
                        <p id="bet-error-message" style="color: red;"></p>
                    </div>
                </div>
            </div>
            
            <div style="flex: 1;" id="cart-wrapper">
                <h3>è³¼å…¥ã‚«ãƒ¼ãƒˆ (ã“ã®ãƒ¬ãƒ¼ã‚¹)</h3>
                <div id="cart"></div>
                <p>åˆè¨ˆ: <strong id="cart-total">0</strong> pt</p>
                <button id="purchase-all-button" style="font-size: 1.2em; background: green; color: white;">
                    ã‚«ãƒ¼ãƒˆå†…ã®é¦¬åˆ¸ã‚’ã™ã¹ã¦è³¼å…¥ã™ã‚‹
                </button>
                <p id="purchase-error-message" style="color: red;"></p>
            </div>
        </div>
        <hr>
        <h3>è‡ªãƒãƒ¼ãƒ ã®è³¼å…¥å±¥æ­´ (ã“ã®ãƒ¬ãƒ¼ã‚¹)</h3>
        <p>ï¼ˆè³¼å…¥æ¸ˆã¿é¦¬åˆ¸: <span id="betting-view-bet-count">0</span> / 5 ä»¶ï¼‰</p>
        <div id="betting-view-bet-list"></div>
    </div>

    <div id="payout-view" class="hidden">
        <h2 class="points-display-header">ç¾åœ¨ã®ãƒã‚¤ãƒ³ãƒˆ: <span class="team-points-display">...</span> pt</h2>
        <h1 id="payout-header"></h1>
        <button id="back-to-race-menu-from-payout">ãƒ¬ãƒ¼ã‚¹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
        <hr>
        <div id="payout-content"></div>
    </div>
    
    <div id="bet-results-view" class="hidden">
        <h2 class="points-display-header">ç¾åœ¨ã®ãƒã‚¤ãƒ³ãƒˆ: <span class="team-points-display">...</span> pt</h2>
        <h1 id="bet-results-header"></h1>
        <button id="back-to-race-menu-from-results">ãƒ¬ãƒ¼ã‚¹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
        <hr>
        <div id="bet-results-content"></div>
    </div>
    
    <div id="final-results-view" class="hidden">
        <h2 class="points-display-header">ç¾åœ¨ã®ãƒã‚¤ãƒ³ãƒˆ: <span class="team-points-display">...</span> pt</h2>
        <h1>æœ€çµ‚çµæœãƒ©ãƒ³ã‚­ãƒ³ã‚°</h1>
        <button id="back-to-team-menu-from-final">ãƒ¬ãƒ¼ã‚¹ä¸€è¦§ã«æˆ»ã‚‹</button>
        <hr>
        <div id="final-results-content">
            <p>ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
    </div>


    <div id="final-results-button-wrapper" class="hidden">
        <button id="goto-final-results-btn" style="background: blue; color: white; font-size: 1.1em;">
            ğŸ† æœ€çµ‚çµæœã‚’è¦‹ã‚‹
        </button>
    </div>


    <div id="host-view" class="hidden">
        <h1>ç®¡ç†è€… (Host) ãƒ‘ãƒãƒ«</h1>
        <button id="host-logout">å½¹å‰²é¸æŠã«æˆ»ã‚‹</button>
        <hr>

        <h3>ã‚²ãƒ¼ãƒ ç®¡ç†</h3>
        <button id="reset-points-button">å…¨ãƒãƒ¼ãƒ ã®ãƒã‚¤ãƒ³ãƒˆã‚’1000ã«ãƒªã‚»ãƒƒãƒˆ</button>
        <button id="reset-bets-button" style="background: #a00; color: white; margin-left: 10px;">
            å…¨é¦¬åˆ¸å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆ (!!!)
        </button>
        <button id="reset-results-button" style="background: #a00; color: white; margin-left: 10px;">
            å…¨æ‰•ã„æˆ»ã—çµæœã‚’ãƒªã‚»ãƒƒãƒˆ (!!!)
        </button>
        <div style="padding: 10px; border: 1px solid blue; margin-top: 10px;">
            <strong>æœ€çµ‚çµæœ:</strong>
            <button id="final-results-public-btn">å…¬é–‹ã™ã‚‹</button>
            <button id="final-results-hidden-btn">éå…¬é–‹ã«ã™ã‚‹</button>
        </div>

        <h3>ãƒ¬ãƒ¼ã‚¹å—ä»˜ç®¡ç†</h3>
        <table border="1" style="width: 100%;">
            <thead><tr><th>ãƒ¬ãƒ¼ã‚¹</th><th>æƒ…å ±å…¬é–‹ (Visibility)</th><th>é¦¬åˆ¸å—ä»˜ (Status)</th></tr></thead>
            <tbody>
                <tr>
                    <td><strong>ãƒ¬ãƒ¼ã‚¹0</strong></td>
                    <td>
                        <button class="visibility-btn" data-race="race0" data-visibility="public">å…¬é–‹</button>
                        <button class="visibility-btn" data-race="race0" data-visibility="hidden">éå…¬é–‹</button>
                    </td>
                    <td>
                        <button class="status-btn" data-race="race0" data-status="open">å—ä»˜é–‹å§‹</button>
                        <button class="status-btn" data-race="race0" data-status="closed">å—ä»˜çµ‚äº†</button>
                    </td>
                </tr>
                
                <tr>
                    <td><strong>ãƒ¬ãƒ¼ã‚¹1</strong></td>
                    <td>
                        <button class="visibility-btn" data-race="race1" data-visibility="public">å…¬é–‹</button>
                        <button class="visibility-btn" data-race="race1" data-visibility="hidden">éå…¬é–‹</button>
                    </td>
                    <td>
                        <button class="status-btn" data-race="race1" data-status="open">å—ä»˜é–‹å§‹</button>
                        <button class="status-btn" data-race="race1" data-status="closed">å—ä»˜çµ‚äº†</button>
                    </td>
                </tr>
                <tr>
                    <td><strong>ãƒ¬ãƒ¼ã‚¹2</strong></td>
                    <td>
                        <button class="visibility-btn" data-race="race2" data-visibility="public">å…¬é–‹</button>
                        <button class="visibility-btn" data-race="race2" data-visibility="hidden">éå…¬é–‹</button>
                    </td>
                    <td>
                        <button class="status-btn" data-race="race2" data-status="open">å—ä»˜é–‹å§‹</button>
                        <button class="status-btn" data-race="race2" data-status="closed">å—ä»˜çµ‚äº†</button>
                    </td>
                </tr>
                <tr>
                    <td><strong>ãƒ¬ãƒ¼ã‚¹3</strong></td>
                    <td>
                        <button class="visibility-btn" data-race="race3" data-visibility="public">å…¬é–‹</button>
                        <button class="visibility-btn" data-race="race3" data-visibility="hidden">éå…¬é–‹</button>
                    </td>
                    <td>
                        <button class="status-btn" data-race="race3" data-status="open">å—ä»˜é–‹å§‹</button>
                        <button class="status-btn" data-race="race3" data-status="closed">å—ä»˜çµ‚äº†</button>
                    </td>
                </tr>
            </tbody>
        </table>
        <hr>

        <h3>é…å½“è¨­å®šã¨æ‰•ã„æˆ»ã—</h3>
        <div id="payout-form" style="border: 2px solid #a00; padding: 10px; background: #fdd;">
            <div>
                <label>å¯¾è±¡ãƒ¬ãƒ¼ã‚¹å:</label>
                <input type="text" id="payout-race-name" placeholder="ä¾‹: ãƒ¬ãƒ¼ã‚¹1">
                <strong style="color: red;">ï¼ˆé‡è¦ï¼šã“ã®ãƒ¬ãƒ¼ã‚¹åã®æœªæ‰•ã„é¦¬åˆ¸ã‚’å…¨ã¦å‡¦ç†ã—ã¾ã™ï¼‰</strong>
            </div>
            <h4>1. ç€é †ï¼ˆçµæœï¼‰ã®å…¥åŠ›</h4>
            <div>
                <label>1ç€:</label> <input type="number" class="winner-horse" id="winner-1st" min="1" max="16">
                <label>2ç€:</label> <input type="number" class="winner-horse" id="winner-2nd" min="1" max="16">
                <label>3ç€:</label> <input type="number" class="winner-horse" id="winner-3rd" min="1" max="16">
            </div>
            <h4>2. é…å½“å€ç‡ã®å…¥åŠ›</h4>
            <div><label>å˜å‹:</label> <input type="number" class="odds-input" id="odds-Tansho" value="10"> å€</div>
            <div><label>äºŒé€£å˜:</label> <input type="number" class="odds-input" id="odds-Nirentan" value="15"> å€</div>
            <div><label>äºŒé€£è¤‡:</label> <input type="number" class="odds-input" id="odds-Nirenfuku" value="20"> å€</div>
            <div><label>ä¸‰é€£è¤‡:</label> <input type="number" class="odds-input" id="odds-Sanrenpuku" value="50"> å€</div>
            <div><label>ä¸‰é€£å˜:</label> <input type="number" class="odds-input" id="odds-Sanrentan" value="100"> å€</div>
            <button id="execute-payout-button" style="font-size: 1.2em; background: red; color: white;">
                æ‰•ã„æˆ»ã—ã‚’å®Ÿè¡Œã™ã‚‹ (!!!å–ã‚Šæ¶ˆã—ä¸å¯!!!)
            </button>
            <p id="payout-status-message" style="color: blue;"></p>
        </div>

        <h3>å…¨ãƒãƒ¼ãƒ ã®è³¼å…¥å±¥æ­´</h3>
        <div id="host-bet-list"></div>
    </div>


    <script>
        // -------------------------------------
        // Firebaseã®åˆæœŸè¨­å®š
        // -------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyBTWWlIb2AZEejTU7Vc5NTdcu6cYYU3qYU",
            authDomain: "test-2776f.firebaseapp.com",
            projectId: "test-2776f",
            storageBucket: "test-2776f.firebasestorage.app",
            messagingSenderId: "41664113525",
            appId: "1:41664113525:web:2a86060775c7580266813c",
            measurementId: "G-KD7Z5H6B41"
        };

        // Firebaseã‚’åˆæœŸåŒ–
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(app);
        const increment = firebase.firestore.FieldValue.increment; 
        console.log("Firebaseã®æ¥ç¶šæº–å‚™å®Œäº†ï¼");
        

        // -------------------------------------
        // ç”»é¢ã®è¦ç´ ï¼ˆHTMLéƒ¨å“ï¼‰ã‚’å–å¾—
        // -------------------------------------
        // ç”»é¢å…¨ä½“
        const loginScreen = document.getElementById("login-screen");
        const teamView = document.getElementById("team-view");
        const hostView = document.getElementById("host-view");
        const bettingView = document.getElementById("betting-view"); 
        const raceMenuView = document.getElementById("race-menu-view"); 
        const payoutView = document.getElementById("payout-view");
        const betResultsView = document.getElementById("bet-results-view");
        const finalResultsView = document.getElementById("final-results-view"); 
        const teamPointsDisplays = document.querySelectorAll(".team-points-display"); 

        // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢
        const teamSelectButtons = document.querySelectorAll(".team-select");
        const hostLoginButton = document.getElementById("host-login");
        
        // ãƒãƒ¼ãƒ ç”»é¢ (ãƒ¬ãƒ¼ã‚¹ä¸€è¦§)
        const teamHeader = document.getElementById("team-header");
        const teamLogoutButton = document.getElementById("team-logout");
        const raceSelectButtons = document.querySelectorAll(".race-select-btn"); 
        
        const raceStatusSpans = { 
            0: document.getElementById("race-status-0"), 
            1: document.getElementById("race-status-1"), 
            2: document.getElementById("race-status-2"), 
            3: document.getElementById("race-status-3") 
        };
        const raceWrappers = { 
            0: document.getElementById("race-0-wrapper"), 
            1: document.getElementById("race-1-wrapper"), 
            2: document.getElementById("race-2-wrapper"), 
            3: document.getElementById("race-3-wrapper") 
        };
        
        // ãƒ¬ãƒ¼ã‚¹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢
        const raceMenuHeader = document.getElementById("race-menu-header");
        const backToTeamMenuButton = document.getElementById("back-to-team-menu");
        
        // â˜…â˜…â˜… 2ã¤ã®ãƒœã‚¿ãƒ³ã‚’å–å¾—ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ â˜…â˜…â˜…
        const downloadPdfButton = document.getElementById("download-pdf-btn");
        const downloadCsvButton = document.getElementById("download-csv-btn");
        
        const gotoBettingButton = document.getElementById("goto-betting-btn");
        const showPayoutsButton = document.getElementById("show-payouts-btn"); 
        const showBetResultsButton = document.getElementById("show-bet-results-btn"); 
        const raceMenuBetListDiv = document.getElementById("race-menu-bet-list"); 
        const raceMenuBetCount = document.getElementById("race-menu-bet-count"); 

        // é¦¬åˆ¸è³¼å…¥ç”»é¢ (ã‚«ãƒ¼ãƒˆ)
        const bettingHeader = document.getElementById("betting-header");
        const backToRaceMenuButton = document.getElementById("back-to-race-menu"); 
        const betTypeSelect = document.getElementById("bet-type-select");
        const betAmountInput = document.getElementById("bet-amount-input");
        const addToCartButton = document.getElementById("add-to-cart-button");
        const betErrorMessage = document.getElementById("bet-error-message");
        const cartDiv = document.getElementById("cart");
        const cartTotalSpan = document.getElementById("cart-total");
        const purchaseAllButton = document.getElementById("purchase-all-button");
        const purchaseErrorMessage = document.getElementById("purchase-error-message");
        const horseInputs = {
            1: { label: document.getElementById("horse-label-1"), input: document.getElementById("horse-input-1") },
            2: { label: document.getElementById("horse-label-2"), input: document.getElementById("horse-input-2") },
            3: { label: document.getElementById("horse-label-3"), input: document.getElementById("horse-input-3") }
        };
        const bettingViewBetListDiv = document.getElementById("betting-view-bet-list"); 
        const bettingViewBetCount = document.getElementById("betting-view-bet-count"); 

        const bettingStatusMessageWrapper = document.getElementById("betting-status-message-wrapper");
        const bettingStatusMessage = document.getElementById("betting-status-message");
        const bettingForm = document.getElementById("betting-form"); // ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã®è¦ª
        const cartWrapper = document.getElementById("cart-wrapper"); // ã‚«ãƒ¼ãƒˆãƒ©ãƒƒãƒ‘ãƒ¼

        // çµæœè¡¨ç¤ºç”»é¢
        const payoutHeader = document.getElementById("payout-header");
        const payoutContent = document.getElementById("payout-content");
        const backToRaceMenuFromPayout = document.getElementById("back-to-race-menu-from-payout");
        const betResultsHeader = document.getElementById("bet-results-header");
        const betResultsContent = document.getElementById("bet-results-content");
        const backToRaceMenuFromResults = document.getElementById("back-to-race-menu-from-results");
        
        // æœ€çµ‚çµæœç”»é¢
        const finalResultsContent = document.getElementById("final-results-content");
        const backToTeamMenuFromFinal = document.getElementById("back-to-team-menu-from-final");
        const finalResultsButtonWrapper = document.getElementById("final-results-button-wrapper");
        const gotoFinalResultsButton = document.getElementById("goto-final-results-btn");

        // ãƒ›ã‚¹ãƒˆç”»é¢
        const hostLogoutButton = document.getElementById("host-logout");
        const resetPointsButton = document.getElementById("reset-points-button");
        const hostBetListDiv = document.getElementById("host-bet-list");
        const resetBetsButton = document.getElementById("reset-bets-button"); 
        const visibilityButtons = document.querySelectorAll(".visibility-btn"); 
        const statusButtons = document.querySelectorAll(".status-btn"); 
        const resetResultsButton = document.getElementById("reset-results-button"); 
        const finalResultsPublicBtn = document.getElementById("final-results-public-btn"); 
        const finalResultsHiddenBtn = document.getElementById("final-results-hidden-btn"); 
        
        // æ‰•ã„æˆ»ã—ãƒ•ã‚©ãƒ¼ãƒ 
        const payoutRaceName = document.getElementById("payout-race-name");
        const winnersInput = { first: document.getElementById("winner-1st"), second: document.getElementById("winner-2nd"), third: document.getElementById("winner-3rd") };
        const oddsInput = { Tansho: document.getElementById("odds-Tansho"), Nirentan: document.getElementById("odds-Nirentan"), Nirenfuku: document.getElementById("odds-Nirenfuku"), Sanrenpuku: document.getElementById("odds-Sanrenpuku"), Sanrentan: document.getElementById("odds-Sanrentan") };
        const executePayoutButton = document.getElementById("execute-payout-button"); 
        const payoutStatusMessage = document.getElementById("payout-status-message");

        // -------------------------------------
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° (çŠ¶æ…‹ç®¡ç†)
        // -------------------------------------
        let currentTeam = null; 
        let isHost = false;
        let currentRace = null; 
        let cart = []; 
        let globalRaceStatus = {}; 
        let currentView = "login"; 
        let currentGameBetCount = 0; 
        
        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç›£è¦–ï¼ˆãƒªã‚¹ãƒŠãƒ¼ï¼‰
        let currentPointsListener = null; 
        let currentBetsListener = null;   
        let raceStatusListener = null; 
        let rankingListener = null; 
        
        // é¦¬åˆ¸ã®è¡¨ç¤ºåã¨åŒºåˆ‡ã‚Šæ–‡å­—ã®ãƒãƒƒãƒ”ãƒ³ã‚°
        const betTypeDisplay = {
            'Tansho':     { name: 'å˜å‹',   separator: '' },
            'Nirentan':   { name: 'äºŒé€£å˜', separator: 'â†’' },
            'Nirenfuku':  { name: 'äºŒé€£è¤‡', separator: '-' },
            'Sanrenpuku': { name: 'ä¸‰é€£è¤‡', separator: '-' },
            'Sanrentan':  { name: 'ä¸‰é€£å˜', separator: 'â†’' }
        };

        // -------------------------------------
        // ãƒ“ãƒ¥ãƒ¼ï¼ˆç”»é¢ï¼‰ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•° (Step 29 ä¿®æ­£ç‰ˆ)
        // -------------------------------------
        function updateView() {
            // ä¸€æ—¦ã™ã¹ã¦éš ã™
            loginScreen.classList.add("hidden");
            teamView.classList.add("hidden");
            hostView.classList.add("hidden");
            raceMenuView.classList.add("hidden"); 
            bettingView.classList.add("hidden"); 
            payoutView.classList.add("hidden"); 
            betResultsView.classList.add("hidden");
            finalResultsView.classList.add("hidden"); 
            finalResultsButtonWrapper.classList.add("hidden"); 

            // --- ç›£è¦–ã‚’åœæ­¢ ---
            if (currentPointsListener) { currentPointsListener(); currentPointsListener = null; }
            if (currentBetsListener) { currentBetsListener(); currentBetsListener = null; } 
            if (raceStatusListener) { raceStatusListener(); raceStatusListener = null; } 
            if (rankingListener) { rankingListener(); rankingListener = null; } 

            // --- çŠ¶æ…‹ã«åŸºã¥ã„ã¦ç›£è¦–ã‚’é–‹å§‹ & ç”»é¢ã‚’è¡¨ç¤º ---
            if (isHost) {
                currentView = "host";
            } else if (!currentTeam) {
                currentView = "login";
            }
            // (currentView ã¯ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã«è¨­å®šã•ã‚Œã‚‹)

            // Hostä»¥å¤–ãªã‚‰ã€ãƒã‚¤ãƒ³ãƒˆç›£è¦–ã‚’é–‹å§‹
            if (!isHost && currentTeam) {
                startPointsListener();
            }

            switch (currentView) {
                case "host":
                    hostView.classList.remove("hidden");
                    startBetListListener(); 
                    startRaceStatusListener(); 
                    break;
                case "team":
                    teamView.classList.remove("hidden");
                    teamHeader.textContent = `ã‚ˆã†ã“ã, Team ${currentTeam}`;
                    startRaceStatusListener(); 
                    break;
                case "raceMenu":
                    raceMenuView.classList.remove("hidden"); 
                    raceMenuHeader.textContent = `${currentRace} ãƒ¡ãƒ‹ãƒ¥ãƒ¼`;
                    
                    // (ãƒœã‚¿ãƒ³ãŒ2ã¤ã«ãªã£ãŸãŸã‚ã€ãƒ†ã‚­ã‚¹ãƒˆå¤‰æ›´å‡¦ç†ã¯ä¸è¦)

                    startRaceStatusListener(); 
                    startBetListListener(); 
                    break;
                case "betting":
                    bettingView.classList.remove("hidden");
                    bettingHeader.textContent = `${currentRace} ã®é¦¬åˆ¸è³¼å…¥`;
                    startRaceStatusListener(); // ãƒ•ã‚©ãƒ¼ãƒ ãƒ­ãƒƒã‚¯ã®ãŸã‚ã« StatusListener ã‚’é–‹å§‹
                    startBetListListener(); 
                    break;
                case "payouts": 
                    payoutView.classList.remove("hidden");
                    payoutHeader.textContent = `${currentRace} é…å½“`;
                    renderPayouts(); 
                    break;
                case "betResults": 
                    betResultsView.classList.remove("hidden");
                    betResultsHeader.textContent = `${currentRace} æ‰•ã„æˆ»ã—ä¸€è¦§`;
                    renderBetResults(); 
                    break;
                case "finalResults": 
                    finalResultsView.classList.remove("hidden");
                    startRankingListener(); 
                    break;
                default: // login
                    loginScreen.classList.remove("hidden");
            }
        }
        
        // -------------------------------------
        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç›£è¦–ï¼ˆãƒªã‚¹ãƒŠãƒ¼ï¼‰é–¢æ•°
        // -------------------------------------
        
        // ãƒã‚¤ãƒ³ãƒˆç›£è¦– (Team) (ã‚¹ãƒ†ãƒƒãƒ—28ã®ã‚³ãƒ¼ãƒ‰)
        function startPointsListener() {
            teamPointsDisplays.forEach(span => span.textContent = "...èª­ã¿è¾¼ã¿ä¸­...");
            currentPointsListener = db.collection("teams").doc(currentTeam)
                .onSnapshot((doc) => {
                    let points = "0";
                    if (doc.exists) {
                        points = doc.data().points;
                    }
                    teamPointsDisplays.forEach(span => span.textContent = points);
                }, (error) => { 
                    teamPointsDisplays.forEach(span => span.textContent = "ã‚¨ãƒ©ãƒ¼");
                });
        }

        // é¦¬åˆ¸å±¥æ­´ç›£è¦– (Team & Host) (ã‚¹ãƒ†ãƒƒãƒ—26ã®ãƒã‚°ä¿®æ­£ç‰ˆ)
        function startBetListListener() {
            if (isHost) {
                // Host listener (å…¨ãƒ¬ãƒ¼ã‚¹, createdAt ã§ã‚½ãƒ¼ãƒˆ)
                currentBetsListener = db.collection("bets").orderBy("createdAt", "desc")
                    .onSnapshot((snapshot) => {
                        hostBetListDiv.innerHTML = ""; // Clear only host
                        let elements = [];
                        snapshot.forEach(doc => {
                            elements.push(createBetHistoryElement(doc.id, doc.data()));
                        });
                        elements.forEach(el => hostBetListDiv.appendChild(el));
                        // (Hostã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ä¸è¦)
                    }, (error) => { console.error("Host é¦¬åˆ¸å±¥æ­´ã‚¨ãƒ©ãƒ¼:", error); });
            } 
            // ãƒãƒ¼ãƒ ã§ã€ã‹ã¤ãƒ¬ãƒ¼ã‚¹ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿
            else if (currentTeam && currentRace) {
                // Team listener (é¸æŠä¸­ã®ãƒ¬ãƒ¼ã‚¹ã®ã¿)
                currentBetsListener = db.collection("bets")
                    .where("team", "==", currentTeam)
                    .where("race", "==", currentRace) 
                    .onSnapshot((snapshot) => {
                        raceMenuBetListDiv.innerHTML = ""; 
                        bettingViewBetListDiv.innerHTML = "";
                        
                        let bets = []; // ã‚½ãƒ¼ãƒˆç”¨é…åˆ—
                        snapshot.forEach(doc => {
                            bets.push({ id: doc.id, data: doc.data() });
                        });
                        
                        bets.sort((a, b) => b.data.createdAt.toDate() - a.data.createdAt.toDate());

                        currentGameBetCount = bets.length;
                        raceMenuBetCount.textContent = currentGameBetCount;
                        bettingViewBetCount.textContent = currentGameBetCount;
                        
                        bets.forEach(bet => {
                            const p = createBetHistoryElement(bet.id, bet.data);
                            raceMenuBetListDiv.appendChild(p.cloneNode(true));
                            bettingViewBetListDiv.appendChild(p);
                        });
                        
                        addCancelButtonListeners();
                        
                        // è¿½åŠ : é¦¬åˆ¸ãƒªã‚¹ãƒˆãŒæ›´æ–°ã•ã‚ŒãŸã®ã§ã€ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã‚’å†é©ç”¨
                        updateBettingViewLockState();

                    }, (error) => { 
                        if (error.code === 'failed-precondition') {
                            alert("ã‚¨ãƒ©ãƒ¼: è³¼å…¥å±¥æ­´ã®å–å¾—ã«å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“ã€‚Firebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®ã‚¨ãƒ©ãƒ¼ãƒªãƒ³ã‚¯ã‹ã‚‰ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚");
                        } else {
                            console.error("Team é¦¬åˆ¸å±¥æ­´ã‚¨ãƒ©ãƒ¼:", error);
                        }
                    });
            }
        }
        
        // é¦¬åˆ¸å±¥æ­´ã®HTMLè¦ç´ (pã‚¿ã‚°)ã‚’ä½œæˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° (ã‚¹ãƒ†ãƒƒãƒ—27ã®ã‚³ãƒ¼ãƒ‰)
        function createBetHistoryElement(betId, bet) {
            const displayInfo = betTypeDisplay[bet.type] || { name: bet.type, separator: '-' };
            const betDetails = `${displayInfo.name}: ${bet.horses.join(displayInfo.separator)}`;
            const teamColor = bet.team.toLowerCase(); 
            const p = document.createElement("p");
            p.className = "bet-history-item"; 
            
            // ä¿®æ­£: Yellowã®æ–‡å­—è‰²ã‚’æš—ãã™ã‚‹
            if (teamColor === "yellow") {
                p.style.color = "#b7950b"; // æš—ã„é»„è‰²ï¼ˆãƒã‚¹ã‚¿ãƒ¼ãƒ‰ï¼‰
            } else {
                p.style.color = teamColor;
            }
            
            let html = `[${bet.race}] <strong>${betDetails}</strong> ã« <strong>${bet.amount} pt</strong> (çŠ¶æ…‹: ${bet.paid ? 'æ‰•æˆ»æ¸ˆ' : 'æœªæ‰•æˆ»'})`;
            
            if (!bet.paid) {
                html += ` <button class="cancel-bet-button" data-id="${betId}" data-amount="${bet.amount}">å–ã‚Šæ¶ˆã—</button>`;
            }
            
            p.innerHTML = html;
            return p;
        }

        // ãƒ¬ãƒ¼ã‚¹çŠ¶æ…‹ç›£è¦– (Team & Host) (Step 29)
        function startRaceStatusListener() {
            raceStatusListener = db.collection("races").doc("status")
                .onSnapshot((doc) => {
                    globalRaceStatus = doc.exists ? doc.data() : {}; 
                    
                    updateRaceVisibilityAndStatus("race0", raceWrappers[0], raceStatusSpans[0]); 
                    updateRaceVisibilityAndStatus("race1", raceWrappers[1], raceStatusSpans[1]);
                    updateRaceVisibilityAndStatus("race2", raceWrappers[2], raceStatusSpans[2]);
                    updateRaceVisibilityAndStatus("race3", raceWrappers[3], raceStatusSpans[3]);
                    
                    // æœ€çµ‚çµæœãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’æ›´æ–°
                    if (!isHost && globalRaceStatus.finalResultsVisible === true) {
                        finalResultsButtonWrapper.classList.remove("hidden");
                    } else {
                        finalResultsButtonWrapper.classList.add("hidden");
                    }
                    
                    // è¿½åŠ : é¦¬åˆ¸è³¼å…¥ç”»é¢ã®ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã‚’æ›´æ–°
                    updateBettingViewLockState();

                });
        }
        
        // ãƒãƒ¼ãƒ ç”»é¢ã®ãƒ¬ãƒ¼ã‚¹è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° (Step 19)
        function updateRaceVisibilityAndStatus(raceId, wrapper, span) {
            const raceData = globalRaceStatus[raceId] || { visibility: "hidden", status: "closed" };
            if (raceData.visibility === "public") {
                wrapper.classList.remove("hidden");
            } else {
                wrapper.classList.add("hidden");
            }
            if (raceData.status === "open") {
                span.textContent = "ï¼ˆå—ä»˜ä¸­ï¼‰";
                span.className = "race-status status-open";
            } else {
                span.textContent = "ï¼ˆå—ä»˜çµ‚äº†ï¼‰";
                span.className = "race-status status-closed";
            }
        }
        
        // (é¦¬åˆ¸è³¼å…¥ç”»é¢å°‚ç”¨) ãƒ•ã‚©ãƒ¼ãƒ ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§åˆ‡ã‚Šæ›¿ãˆã‚‹
        function updateBettingViewLockState() {
            // betting-view ä»¥å¤–ã®ç”»é¢ã«ã„ã‚‹ã‹ã€ãƒ¬ãƒ¼ã‚¹ãŒé¸æŠã•ã‚Œã¦ã„ãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„
            if (currentView !== "betting" || !currentRace) {
                return; 
            }

            const raceId = getRaceIdFromName(currentRace);
            const raceData = globalRaceStatus[raceId] || { status: "closed" };

            if (raceData.status === "open") {
                // --- å—ä»˜ä¸­ ---
                bettingStatusMessageWrapper.classList.add("unlocked");
                bettingStatusMessageWrapper.classList.remove("locked");
                bettingStatusMessage.textContent = "ï¼ˆç¾åœ¨ã€é¦¬åˆ¸ã®è³¼å…¥ãƒ»å–ã‚Šæ¶ˆã—ãŒå¯èƒ½ã§ã™ï¼‰";
                bettingStatusMessage.className = "race-status status-open";

                // ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ­ãƒƒã‚¯ã‚’è§£é™¤
                bettingForm.classList.remove("locked");
                cartWrapper.classList.remove("locked");
                
                // å±¥æ­´ã®ã€Œå–ã‚Šæ¶ˆã—ã€ãƒœã‚¿ãƒ³ã‚’ï¼ˆã‚‚ã—ã‚ã‚Œã°ï¼‰å†è¡¨ç¤º
                document.querySelectorAll("#betting-view-bet-list .cancel-bet-button").forEach(btn => {
                    btn.classList.remove("hidden");
                });

            } else {
                // --- å—ä»˜çµ‚äº† ---
                bettingStatusMessageWrapper.classList.add("locked");
                bettingStatusMessageWrapper.classList.remove("unlocked");
                bettingStatusMessage.textContent = "ï¼ˆã“ã®ãƒ¬ãƒ¼ã‚¹ã®é¦¬åˆ¸å—ä»˜ã¯çµ‚äº†ã—ã¾ã—ãŸï¼‰";
                bettingStatusMessage.className = "race-status status-closed";

                // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒ­ãƒƒã‚¯
                bettingForm.classList.add("locked");
                cartWrapper.classList.add("locked");

                // å±¥æ­´ã®ã€Œå–ã‚Šæ¶ˆã—ã€ãƒœã‚¿ãƒ³ã‚’å¼·åˆ¶çš„ã«éš ã™
                document.querySelectorAll("#betting-view-bet-list .cancel-bet-button").forEach(btn => {
                    btn.classList.add("hidden");
                });
                
                // ã‚«ãƒ¼ãƒˆã‚’ç©ºã«ã™ã‚‹ï¼ˆå—ä»˜çµ‚äº†æ™‚ã«ã‚«ãƒ¼ãƒˆã«æ®‹ã£ã¦ã„ã¦ã‚‚è²·ãˆãªã„ãŸã‚ï¼‰
                if (cart.length > 0) {
                    cart = [];
                    updateCartView();
                    purchaseErrorMessage.textContent = "å—ä»˜ãŒçµ‚äº†ã—ãŸãŸã‚ã€ã‚«ãƒ¼ãƒˆãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸã€‚";
                }
            }
        }

        // -------------------------------------
        // çµæœæç”»é–¢æ•°
        // -------------------------------------
        
        // ã€Œé…å½“ã€ãƒ“ãƒ¥ãƒ¼ã‚’æç”»ã™ã‚‹ (ã‚¹ãƒ†ãƒƒãƒ—22)
        async function renderPayouts() {
            payoutContent.innerHTML = "<p>çµæœã‚’èª­ã¿è¾¼ã¿ä¸­...</p>";
            try {
                const resultsDocRef = db.collection("results").doc(currentRace);
                const doc = await resultsDocRef.get();
                if (!doc.exists) {
                    payoutContent.innerHTML = "<p>ã“ã®ãƒ¬ãƒ¼ã‚¹ã®é…å½“ã¯ã¾ã ç™ºè¡¨ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>";
                    return;
                }
                const results = doc.data();
                const w = results.winners; 
                const o = results.odds;     
                
                const nirenfuku = [w.first, w.second].sort((a,b) => a-b).join('-');
                const sanrenpuku = [w.first, w.second, w.third].sort((a,b) => a-b).join('-');
                
                let html = "<h3>ç€é †</h3>";
                html += `<p>1ç€: ${w.first} ç•ª, 2ç€: ${w.second} ç•ª, 3ç€: ${w.third} ç•ª</p>`;
                html += "<h3>çš„ä¸­é¦¬åˆ¸ã¨é…å½“ (1ptã‚ãŸã‚Š)</h3>";
                html += `<table class="results-table">
                    <tr><th>é¦¬åˆ¸ç¨®</th><th>çš„ä¸­é¦¬ç•ª</th><th>é…å½“</th></tr>
                    <tr><td>å˜å‹</td><td>${w.first}</td><td>${o.Tansho} å€</td></tr>
                    <tr><td>äºŒé€£å˜</td><td>${w.first}â†’${w.second}</td><td>${o.Nirentan} å€</td></tr>
                    <tr><td>äºŒé€£è¤‡</td><td>${nirenfuku}</td><td>${o.Nirenfuku} å€</td></tr>
                    <tr><td>ä¸‰é€£è¤‡</td><td>${sanrenpuku}</td><td>${o.Sanrenpuku} å€</td></tr>
                    <tr><td>ä¸‰é€£å˜</td><td>${w.first}â†’${w.second}â†’${w.third}</td><td>${o.Sanrentan} å€</td></tr>
                </table>`;
                
                payoutContent.innerHTML = html;

            } catch (error) {
                console.error("é…å½“ã®å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
                payoutContent.innerHTML = "<p>é…å½“ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>";
            }
        }

        // ã€Œæ‰•ã„æˆ»ã—ä¸€è¦§ã€ãƒ“ãƒ¥ãƒ¼ã‚’æç”»ã™ã‚‹ (ã‚¹ãƒ†ãƒƒãƒ—24ã®ãƒã‚°ä¿®æ­£ç‰ˆ)
        async function renderBetResults() {
            betResultsContent.innerHTML = "<p>çµæœã‚’èª­ã¿è¾¼ã¿ä¸­...</p>";
            try {
                const resultsDocRef = db.collection("results").doc(currentRace);
                const resultsDoc = await resultsDocRef.get();
                if (!resultsDoc.exists) {
                    betResultsContent.innerHTML = "<p>ã“ã®ãƒ¬ãƒ¼ã‚¹ã¯ã¾ã æ‰•ã„æˆ»ã—å‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>";
                    return;
                }
                const results = resultsDoc.data();
                const odds = results.odds;

                // (ä¿®æ­£ç‚¹) orderBy("team") ã‚’å‰Šé™¤
                const betQuerySnapshot = await db.collection("bets")
                    .where("race", "==", currentRace)
                    .where("paid", "==", true) 
                    .get();
                
                if (betQuerySnapshot.empty) {
                    betResultsContent.innerHTML = "<p>ã“ã®ãƒ¬ãƒ¼ã‚¹ã®å‡¦ç†æ¸ˆã¿é¦¬åˆ¸ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
                    return;
                }

                let html = `<table class="results-table">
                    <tr><th>ãƒãƒ¼ãƒ </th><th>è³¼å…¥é¦¬åˆ¸</th><th>è³¼å…¥pt</th><th>ç²å¾—pt</th></tr>`;
                
                let winnerCount = 0;
                let bets = []; // JSã§ã‚½ãƒ¼ãƒˆã™ã‚‹ãŸã‚
                betQuerySnapshot.forEach(doc => bets.push(doc.data()));

                // JavaScriptå´ã§ã‚½ãƒ¼ãƒˆ
                bets.sort((a, b) => a.team.localeCompare(b.team)); 
                
                bets.forEach((bet) => { 
                    const displayInfo = betTypeDisplay[bet.type] || { name: bet.type, separator: '-' };
                    const betDetails = `${displayInfo.name}: ${bet.horses.join(displayInfo.separator)}`;
                    
                    if (checkWinner(bet, results.winners)) {
                        winnerCount++;
                        const payoutAmount = bet.amount * odds[bet.type];
                        html += `<tr class="winner-bet">
                            <td>${bet.team}</td>
                            <td>${betDetails}</td>
                            <td>${bet.amount} pt</td>
                            <td><strong>${payoutAmount} pt ç²å¾—ï¼</strong></td>
                        </tr>`;
                    }
                });
                
                html += "</table>";
                
                if (winnerCount === 0) {
                    betResultsContent.innerHTML = "<p>çš„ä¸­é¦¬åˆ¸ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>";
                } else {
                    betResultsContent.innerHTML = html;
                }
            } catch (error) {
                console.error("æ‰•ã„æˆ»ã—ä¸€è¦§ã®å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
                betResultsContent.innerHTML = "<p>æ‰•ã„æˆ»ã—ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>";
            }
        }
        
        // (ã‚¹ãƒ†ãƒƒãƒ—29ã®ã‚³ãƒ¼ãƒ‰)
        // ã€Œæœ€çµ‚çµæœã€ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®ç›£è¦–ã¨æç”»
        function startRankingListener() {
            finalResultsContent.innerHTML = "<p>ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>";
            rankingListener = db.collection("teams")
                .onSnapshot((snapshot) => {
                    let teams = [];
                    snapshot.forEach(doc => {
                        teams.push({ id: doc.id, points: doc.data().points });
                    });
                    
                    // ãƒã‚¤ãƒ³ãƒˆã®é™é †ã§ã‚½ãƒ¼ãƒˆ
                    teams.sort((a, b) => b.points - a.points);
                    
                    let html = `<table class="results-table" id="final-ranking-table">
                        <tr><th>é †ä½</th><th>ãƒãƒ¼ãƒ </th><th>æ‰€æŒãƒã‚¤ãƒ³ãƒˆ</th></tr>`;
                        
                    teams.forEach((team, index) => {
                        const rank = index + 1;
                        
                        // â˜… ä¿®æ­£: Yellowã®æ–‡å­—è‰²ã‚’æš—ãã™ã‚‹
                        const teamColor = team.id.toLowerCase();
                        const colorStyle = (teamColor === "yellow") ? "#b7950b" : teamColor; // æš—ã„é»„è‰²
                        
                        html += `<tr class="rank-${rank}">
                            <td><strong>${rank} ä½</strong></td>
                            <td style="color: ${colorStyle};">${team.id}</td> 
                            <td><strong>${team.points} pt</strong></td>
                        </tr>`;
                    });
                    
                    html += "</table>";
                    finalResultsContent.innerHTML = html;
                    
                }, (error) => {
                    console.error("ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
                    finalResultsContent.innerHTML = "<p>ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>";
                });
        }

        // -------------------------------------
        // ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ (åŸºæœ¬)
        // -------------------------------------
        teamSelectButtons.forEach(button => {
            button.addEventListener("click", () => {
                currentTeam = button.dataset.team;
                isHost = false;
                currentView = "team"; 
                updateView();
            });
        });

        // â¬‡ï¸ ã‚¹ãƒ†ãƒƒãƒ—30ã§å¤‰æ›´ â¬‡ï¸
        hostLoginButton.addEventListener("click", () => {
            const password = prompt("Hostç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:");
            const correctPassword = "20150007"; // ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®šã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰

            if (password === correctPassword) {
                // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ãŸå ´åˆ
                currentTeam = null;
                isHost = true;
                updateView(); // ãƒ›ã‚¹ãƒˆç”»é¢ã«åˆ‡ã‚Šæ›¿ãˆ
            } else if (password !== null) {
                // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸ä¸€è‡´ã®å ´åˆ (ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ä»¥å¤–)
                alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚");
            }
            // (password === null) ã®å ´åˆ (ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãŒæŠ¼ã•ã‚ŒãŸ) ã¯ä½•ã‚‚ã—ãªã„
        });
        // â¬†ï¸ ã‚¹ãƒ†ãƒƒãƒ—30ã§å¤‰æ›´ â¬†ï¸
        
        teamLogoutButton.addEventListener("click", () => {
            currentTeam = null;
            isHost = false;
            updateView();
        });
        hostLogoutButton.addEventListener("click", () => {
            currentTeam = null;
            isHost = false;
            updateView();
        });

        // ãƒãƒ¼ãƒ ç”»é¢ (ãƒ¬ãƒ¼ã‚¹ä¸€è¦§)
        raceSelectButtons.forEach(button => {
            button.addEventListener("click", () => {
                currentRace = button.dataset.race; 
                currentView = "raceMenu"; 
                cart = []; 
                updateCartView(); 
                updateView(); 
            });
        });

        // ãƒ¬ãƒ¼ã‚¹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢
        backToTeamMenuButton.addEventListener("click", () => {
            currentRace = null; 
            currentView = "team"; 
            updateView(); 
        });
        
        // â˜…â˜…â˜… PDFé–²è¦§ãƒœã‚¿ãƒ³ï¼ˆå…¨ãƒ¬ãƒ¼ã‚¹å¯¾å¿œï¼‰ â˜…â˜…â˜…
        downloadPdfButton.addEventListener("click", () => {
            try {
                // currentRace (ä¾‹: "ãƒ¬ãƒ¼ã‚¹1") ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆ (ä¾‹: "ãƒ¬ãƒ¼ã‚¹1.pdf")
                const pdfFileName = `${currentRace}.pdf`; 
                window.open(encodeURI(pdfFileName), '_blank');
            } catch (e) {
                alert("PDFã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‹ã€ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€‚");
            }
        });

        // â˜…â˜…â˜… CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ï¼ˆå®Ÿãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚ç…§ï¼‰ â˜…â˜…â˜…
        downloadCsvButton.addEventListener("click", () => {
            try {
                // 1. ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆ (ä¾‹: "ãƒ¬ãƒ¼ã‚¹1.csv")
                const csvFileName = `${currentRace}.csv`;

                // 2. ãƒ€ãƒŸãƒ¼ã® <a> ã‚¿ã‚°ã‚’ä½œæˆ
                const link = document.createElement("a");
                
                // 3. <a> ã‚¿ã‚°ã«ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã¨downloadå±æ€§ã‚’è¨­å®š
                link.setAttribute("href", encodeURI(csvFileName));
                link.setAttribute("download", csvFileName); 

                // 4. ç”»é¢å¤–ã§ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œ
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

            } catch (e) {
                alert("CSVã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");
            }
        });
        // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…

        gotoBettingButton.addEventListener("click", () => {
            const raceId = getRaceIdFromName(currentRace); 
            if (globalRaceStatus[raceId] && globalRaceStatus[raceId].status === "open") {
                currentView = "betting"; 
                updateView(); 
            } else {
                alert("ã“ã®ãƒ¬ãƒ¼ã‚¹ã®é¦¬åˆ¸å—ä»˜ã¯çµ‚äº†ã—ã¦ã„ã¾ã™ã€‚");
            }
        });
        
        // (ã‚¹ãƒ†ãƒƒãƒ—22ã®ã‚³ãƒ¼ãƒ‰)
        showPayoutsButton.addEventListener("click", () => {
            currentView = "payouts"; 
            updateView();
        });
        
        showBetResultsButton.addEventListener("click", () => {
            currentView = "betResults"; 
            updateView();
        });
        
        // é¦¬åˆ¸è³¼å…¥ç”»é¢
        backToRaceMenuButton.addEventListener("click", () => {
            currentView = "raceMenu"; 
            updateView(); 
        });

        // (ã‚¹ãƒ†ãƒƒãƒ—22ã®ã‚³ãƒ¼ãƒ‰)
        // çµæœè¡¨ç¤ºç”»é¢ã®ã€Œæˆ»ã‚‹ã€ãƒœã‚¿ãƒ³
        backToRaceMenuFromPayout.addEventListener("click", () => {
            currentView = "raceMenu"; 
            updateView();
        });
        backToRaceMenuFromResults.addEventListener("click", () => {
            currentView = "raceMenu"; 
            updateView();
        });
        
        // (ã‚¹ãƒ†ãƒƒãƒ—29ã®ã‚³ãƒ¼ãƒ‰)
        // æœ€çµ‚çµæœç”»é¢ã®ã€Œæˆ»ã‚‹ã€ãƒœã‚¿ãƒ³
        backToTeamMenuFromFinal.addEventListener("click", () => {
            currentView = "team"; // ãƒ¬ãƒ¼ã‚¹ä¸€è¦§ã«æˆ»ã‚‹
            currentRace = null; // ãƒ¬ãƒ¼ã‚¹é¸æŠã‚‚è§£é™¤
            updateView();
        });
        
        // æœ€çµ‚çµæœã‚’è¦‹ã‚‹ãƒœã‚¿ãƒ³ (ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°)
        gotoFinalResultsButton.addEventListener("click", () => {
            currentView = "finalResults";
            currentRace = null; // ãƒ¬ãƒ¼ã‚¹é¸æŠã‚’è§£é™¤
            updateView();
        });

        // -------------------------------------
        // Hostç”¨ï¼šå„ç¨®ãƒœã‚¿ãƒ³ (ã‚¹ãƒ†ãƒƒãƒ—29ã®ã‚³ãƒ¼ãƒ‰)
        // -------------------------------------
        resetPointsButton.addEventListener("click", async () => {
            if (!confirm("æœ¬å½“ã«å…¨ãƒãƒ¼ãƒ ã®ãƒã‚¤ãƒ³ãƒˆã‚’1000ptã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) { return; }
            try {
                const batch = db.batch();
                batch.set(db.collection("teams").doc("Red"), { points: 1000 });
                batch.set(db.collection("teams").doc("Green"), { points: 1000 });
                batch.set(db.collection("teams").doc("Blue"), { points: 1000 });
                batch.set(db.collection("teams").doc("Yellow"), { points: 1000 });
                await batch.commit();
                alert("å…¨ãƒãƒ¼ãƒ ã®ãƒã‚¤ãƒ³ãƒˆã‚’1000ptã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚");
            } catch (error) { alert("ãƒã‚¤ãƒ³ãƒˆã®ãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); }
        });
        
        resetBetsButton.addEventListener("click", async () => {
            if (!confirm("ã€!!!è­¦å‘Š!!!ã€‘\næœ¬å½“ã«ã€Œã™ã¹ã¦ã®é¦¬åˆ¸è³¼å…¥å±¥æ­´ã€ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚")) { return; }
            if (prompt("å‰Šé™¤ã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€å¤§æ–‡å­—ã§ 'DELETE' ã¨å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚") !== "DELETE") {
                alert("æ“ä½œã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚"); return;
            }
            try {
                const querySnapshot = await db.collection("bets").get();
                if (querySnapshot.empty) { alert("å‰Šé™¤ã™ã‚‹é¦¬åˆ¸å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚"); return; }
                const batch = db.batch();
                querySnapshot.forEach(doc => { batch.delete(doc.ref); });
                await batch.commit();
                alert(`${querySnapshot.size}ä»¶ã®é¦¬åˆ¸å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
            } catch (error) {
                console.error("å±¥æ­´ã®å‰Šé™¤ã«å¤±æ•—:", error);
                alert("å±¥æ­´ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            }
        });
        
        resetResultsButton.addEventListener("click", async () => {
            if (!confirm("ã€!!!è­¦å‘Š!!!ã€‘\næœ¬å½“ã«ã€Œã™ã¹ã¦ã®æ‰•ã„æˆ»ã—çµæœï¼ˆé…å½“ãƒ‡ãƒ¼ã‚¿ï¼‰ã€ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚")) {
                return;
            }
            if (prompt("å‰Šé™¤ã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€å¤§æ–‡å­—ã§ 'DELETE' ã¨å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚") !== "DELETE") {
                alert("æ“ä½œã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚");
                return;
            }
            try {
                const querySnapshot = await db.collection("results").get();
                if (querySnapshot.empty) {
                    alert("å‰Šé™¤ã™ã‚‹æ‰•ã„æˆ»ã—çµæœã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
                    return;
                }
                const batch = db.batch();
                querySnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                alert(`${querySnapshot.size}ä»¶ã®æ‰•ã„æˆ»ã—çµæœã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã—ãŸã€‚`);

            } catch (error) {
                console.error("çµæœã®å‰Šé™¤ã«å¤±æ•—:", error);
                alert("çµæœã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            }
        });
        
        visibilityButtons.forEach(button => {
            button.addEventListener("click", async () => {
                const raceId = button.dataset.race; 
                const visibility = button.dataset.visibility; 
                try {
                    await db.collection("races").doc("status").update({
                        [`${raceId}.visibility`]: visibility
                    });
                    alert(`${raceId} ã®æƒ…å ±å…¬é–‹ã‚’ã€Œ${visibility}ã€ã«è¨­å®šã—ã¾ã—ãŸã€‚`);
                } catch (error) {
                    if (error.code === 'not-found') {
                        await db.collection("races").doc("status").set({
                            [raceId]: { visibility: visibility }
                        }, { merge: true });
                        alert(`${raceId} ã®æƒ…å ±å…¬é–‹ã‚’ã€Œ${visibility}ã€ã«è¨­å®šã—ã¾ã—ãŸã€‚`);
                    } else {
                        alert("çŠ¶æ…‹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                    }
                }
            });
        });
        statusButtons.forEach(button => {
            button.addEventListener("click", async () => {
                const raceId = button.dataset.race; 
                const status = button.dataset.status; 
                try {
                    await db.collection("races").doc("status").update({
                        [`${raceId}.status`]: status
                    });
                    alert(`${raceId} ã®é¦¬åˆ¸å—ä»˜ã‚’ã€Œ${status}ã€ã«è¨­å®šã—ã¾ã—ãŸã€‚`);
                } catch (error) {
                    if (error.code === 'not-found') {
                        await db.collection("races").doc("status").set({
                            [raceId]: { status: status }
                        }, { merge: true });
                        alert(`${raceId} ã®é¦¬åˆ¸å—ä»˜ã‚’ã€Œ${status}ã€ã«è¨­å®šã—ã¾ã—ãŸã€‚`);
                    } else {
                        alert("çŠ¶æ…‹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                    }
                }
            });
        });
        
        // (ã‚¹ãƒ†ãƒƒãƒ—29ã®ã‚³ãƒ¼ãƒ‰)
        // æœ€çµ‚çµæœã®å…¬é–‹/éå…¬é–‹
        finalResultsPublicBtn.addEventListener("click", async () => {
            try {
                await db.collection("races").doc("status").set({
                    finalResultsVisible: true
                }, { merge: true });
                alert("æœ€çµ‚çµæœã‚’ã€Œå…¬é–‹ã€ã«è¨­å®šã—ã¾ã—ãŸã€‚");
            } catch (e) { alert("è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); }
        });
        finalResultsHiddenBtn.addEventListener("click", async () => {
            try {
                await db.collection("races").doc("status").set({
                    finalResultsVisible: false
                }, { merge: true });
                alert("æœ€çµ‚çµæœã‚’ã€Œéå…¬é–‹ã€ã«è¨­å®šã—ã¾ã—ãŸã€‚");
            } catch (e) { alert("è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); }
        });

        // -------------------------------------
        // é¦¬åˆ¸ã‚«ãƒ¼ãƒˆã®ãƒ­ã‚¸ãƒƒã‚¯ (ã‚¹ãƒ†ãƒƒãƒ—27ã®ã‚³ãƒ¼ãƒ‰)
        // -------------------------------------
        function updateHorseInputs() {
            const betType = betTypeSelect.value;
            let requiredHorses = 0;
            if (betType === "Tansho") { requiredHorses = 1; }
            else if (betType === "Nirentan" || betType === "Nirenfuku") { requiredHorses = 2; }
            else if (betType === "Sanrenpuku" || betType === "Sanrentan") { requiredHorses = 3; }
            for (let i = 1; i <= 3; i++) {
                if (i <= requiredHorses) {
                    horseInputs[i].label.classList.remove("hidden");
                    horseInputs[i].input.classList.remove("hidden");
                } else {
                    horseInputs[i].label.classList.add("hidden");
                    horseInputs[i].input.classList.add("hidden");
                }
            }
        }
        betTypeSelect.addEventListener("change", updateHorseInputs);
        updateHorseInputs(); 

        addToCartButton.addEventListener("click", () => {
            betErrorMessage.textContent = "";
            if (currentGameBetCount + cart.length >= 5) {
                betErrorMessage.textContent = "1ãƒ¬ãƒ¼ã‚¹ã«è³¼å…¥ã§ãã‚‹é¦¬åˆ¸ã¯5ç¨®é¡ã¾ã§ã§ã™ã€‚(ç¾åœ¨ " + (currentGameBetCount + cart.length) + "ä»¶)";
                return;
            }
            const betType = betTypeSelect.value;
            const betAmount = parseInt(betAmountInput.value, 10);
            if (!betType || !betAmount || betAmount <= 0) {
                betErrorMessage.textContent = "é¦¬åˆ¸ã®ç¨®é¡ã¨è³¼å…¥ãƒã‚¤ãƒ³ãƒˆã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"; return;
            }
            const horses = [];
            const requiredHorses = horseInputs[2].input.classList.contains("hidden") ? 1 : (horseInputs[3].input.classList.contains("hidden") ? 2 : 3);
            for (let i = 1; i <= requiredHorses; i++) {
                const horseNum = parseInt(horseInputs[i].input.value, 10);
                if (!horseNum || horseNum < 1 || horseNum > 16) {
                    betErrorMessage.textContent = `é¦¬${i}ã«1ï½16ã®æœ‰åŠ¹ãªç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`; return;
                }
                horses.push(horseNum);
            }
            if (new Set(horses).size !== horses.length) {
                 betErrorMessage.textContent = "é¦¬ç•ªå·ãŒé‡è¤‡ã—ã¦ã„ã¾ã™ã€‚"; return;
            }
            const cartItem = {
                id: Date.now(), race: currentRace, type: betType, horses: horses, amount: betAmount
            };
            cart.push(cartItem);
            updateCartView();
            betAmountInput.value = "";
            for (let i = 1; i <= 3; i++) { horseInputs[i].input.value = ""; }
        });
        
        function updateCartView() {
            cartDiv.innerHTML = ""; 
            let total = 0;
            cart.forEach(item => {
                total += item.amount;
                const div = document.createElement("div");
                div.className = "cart-item";
                const displayInfo = betTypeDisplay[item.type] || { name: item.type, separator: '-' };
                const betDetails = `${displayInfo.name}: ${item.horses.join(displayInfo.separator)}`;
                div.innerHTML = `
                    <strong>${betDetails}</strong>
                    (${item.amount} pt)
                    <button class="remove-cart-item" data-id="${item.id}">å‰Šé™¤</button>
                `;
                cartDiv.appendChild(div);
            });
            cartTotalSpan.textContent = total; 
            document.querySelectorAll(".remove-cart-item").forEach(button => {
                button.addEventListener("click", (e) => {
                    const idToRemove = parseInt(e.target.dataset.id, 10);
                    cart = cart.filter(item => item.id !== idToRemove);
                    updateCartView(); 
                });
            });
        }
        
        purchaseAllButton.addEventListener("click", async () => {
            purchaseErrorMessage.textContent = "";
            if (cart.length === 0) {
                purchaseErrorMessage.textContent = "ã‚«ãƒ¼ãƒˆãŒç©ºã§ã™ã€‚"; return;
            }
            if (currentGameBetCount + cart.length > 5) {
                purchaseErrorMessage.textContent = "1ãƒ¬ãƒ¼ã‚¹ã«è³¼å…¥ã§ãã‚‹é¦¬åˆ¸ã¯5ç¨®é¡ã¾ã§ã§ã™ã€‚(ç¾åœ¨ " + currentGameBetCount + "ä»¶è³¼å…¥æ¸ˆã¿ã€ã‚«ãƒ¼ãƒˆã« " + cart.length + "ä»¶)";
                return;
            }
            const totalCost = parseInt(cartTotalSpan.textContent, 10);
            
            const raceId = getRaceIdFromName(currentRace); 
            
            // (ãƒ•ã‚§ã‚¤ãƒ«ã‚»ãƒ¼ãƒ•) UIãƒ­ãƒƒã‚¯ã¨ã¯åˆ¥ã«ã€ã“ã“ã§ã‚‚ãƒã‚§ãƒƒã‚¯
            if (!globalRaceStatus[raceId] || globalRaceStatus[raceId].status !== "open") {
                purchaseErrorMessage.textContent = `${currentRace} ã®é¦¬åˆ¸å—ä»˜ã¯çµ‚äº†ã—ã¾ã—ãŸã€‚`;
                return;
            }
            const teamDocRef = db.collection("teams").doc(currentTeam);
            try {
                await db.runTransaction(async (transaction) => {
                    const teamDoc = await transaction.get(teamDocRef);
                    if (!teamDoc.exists) { throw new Error("ãƒãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"); }
                    const currentPoints = teamDoc.data().points;
                    if (currentPoints < totalCost) {
                        throw new Error(`ãƒã‚¤ãƒ³ãƒˆãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚(ç¾åœ¨ ${currentPoints} pt / ã‚«ãƒ¼ãƒˆåˆè¨ˆ ${totalCost} pt)`);
                    }
                    cart.forEach(item => {
                        const newBetRef = db.collection("bets").doc(); 
                        transaction.set(newBetRef, {
                            team: currentTeam, race: item.race, type: item.type, horses: item.horses, amount: item.amount, createdAt: new Date(), paid: false
                        });
                    });
                    transaction.update(teamDocRef, { points: increment(-totalCost) });
                });
                alert(`ä¸€æ‹¬è³¼å…¥ãŒå®Œäº†ã—ã¾ã—ãŸï¼ (${cart.length}ä»¶ã€åˆè¨ˆ ${totalCost} pt)`);
                cart = []; 
                updateCartView(); 
            } catch (error) {
                console.error("ä¸€æ‹¬è³¼å…¥å¤±æ•—:", error);
                purchaseErrorMessage.textContent = `è³¼å…¥å¤±æ•—: ${error.message}`;
            }
        });
        
        // -------------------------------------
        // é¦¬åˆ¸ã€Œå–ã‚Šæ¶ˆã—ã€ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆå‰²ã‚Šå½“ã¦ (ã‚¹ãƒ†ãƒƒãƒ—27)
        // -------------------------------------
        function addCancelButtonListeners() {
            // (è¤‡æ•°ã®ãƒªã‚¹ãƒˆã«ã‚ã‚‹ãƒœã‚¿ãƒ³ã™ã¹ã¦ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰²ã‚Šå½“ã¦ã‚‹)
            document.querySelectorAll(".cancel-bet-button").forEach(button => {
                // (é‡è¤‡ã—ã¦ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™»éŒ²ã—ãªã„ã‚ˆã†ã€ç°¡æ˜“çš„ãªãƒã‚§ãƒƒã‚¯)
                if (button.onclick) return; 
                
                button.onclick = async (e) => {
                    const betId = e.target.dataset.id;
                    const amount = parseInt(e.target.dataset.amount, 10);
                    
                    // 1. ãƒ¬ãƒ¼ã‚¹ãŒå—ä»˜ä¸­ã‹ç¢ºèª
                    const raceId = getRaceIdFromName(currentRace); 
                    
                    // (ãƒ•ã‚§ã‚¤ãƒ«ã‚»ãƒ¼ãƒ•) UIãƒ­ãƒƒã‚¯ã¨ã¯åˆ¥ã«ã€ã“ã“ã§ã‚‚ãƒã‚§ãƒƒã‚¯
                    if (!globalRaceStatus[raceId] || globalRaceStatus[raceId].status !== "open") {
                        alert("å—ä»˜æ™‚é–“å¤–ã®ãŸã‚ã€é¦¬åˆ¸ã¯å–ã‚Šæ¶ˆã—ã§ãã¾ã›ã‚“ã€‚");
                        return;
                    }

                    // 2. æœ€çµ‚ç¢ºèª
                    if (!confirm(`æœ¬å½“ã«ã“ã®é¦¬åˆ¸ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿ\n${amount} pt ãŒæ‰•ã„æˆ»ã•ã‚Œã¾ã™ã€‚`)) {
                        return;
                    }
                    
                    // 3. ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§ã€Œå‰Šé™¤ã€ã¨ã€Œãƒã‚¤ãƒ³ãƒˆè¿”å´ã€ã‚’åŒæ™‚ã«å®Ÿè¡Œ
                    try {
                        const teamDocRef = db.collection("teams").doc(currentTeam);
                        const betDocRef = db.collection("bets").doc(betId);
                        
                        await db.runTransaction(async (transaction) => {
                            // ãƒãƒ¼ãƒ ã®ãƒã‚¤ãƒ³ãƒˆã‚’å¢—ã‚„ã™
                            transaction.update(teamDocRef, { points: increment(amount) });
                            // é¦¬åˆ¸ã‚’å‰Šé™¤ã™ã‚‹
                            transaction.delete(betDocRef);
                        });
                        
                        alert("é¦¬åˆ¸ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸã€‚");
                        // (ãƒªã‚¹ãƒˆã¯ onSnapshot ã«ã‚ˆã‚Šè‡ªå‹•ã§æ›´æ–°ã•ã‚Œã¾ã™)
                        
                    } catch (error) {
                        console.error("é¦¬åˆ¸å–ã‚Šæ¶ˆã—å¤±æ•—:", error);
                        alert(`é¦¬åˆ¸ã®å–ã‚Šæ¶ˆã—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
                    }
                };
            });
        }

        // -------------------------------------
        // æ‰•ã„æˆ»ã—ãƒ­ã‚¸ãƒƒã‚¯ (ã‚¹ãƒ†ãƒƒãƒ—24ã®ãƒã‚°ä¿®æ­£)
        // -------------------------------------
        executePayoutButton.addEventListener("click", async () => {
            const raceName = payoutRaceName.value;
            const winners = {
                first: parseInt(winnersInput.first.value, 10),
                second: parseInt(winnersInput.second.value, 10),
                third: parseInt(winnersInput.third.value, 10)
            };
            const odds = {
                Tansho: parseInt(oddsInput.Tansho.value, 10),
                Nirentan: parseInt(oddsInput.Nirentan.value, 10), 
                Nirenfuku: parseInt(oddsInput.Nirenfuku.value, 10),
                Sanrenpuku: parseInt(oddsInput.Sanrenpuku.value, 10),
                Sanrentan: parseInt(oddsInput.Sanrentan.value, 10)
            };
            if (!raceName || !winners.first || !winners.second || !winners.third) {
                alert("ãƒ¬ãƒ¼ã‚¹åã¨ã€1ï½3ç€ã®é¦¬ç•ªã‚’ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return;
            }
            if (new Set([winners.first, winners.second, winners.third]).size !== 3) {
                alert("1ï½3ç€ã®é¦¬ç•ªãŒé‡è¤‡ã—ã¦ã„ã¾ã™ã€‚"); return;
            }
            if (!confirm(`ã€!!!æœ€çµ‚ç¢ºèª!!!ã€‘\nãƒ¬ãƒ¼ã‚¹å: ${raceName}\n1ç€: ${winners.first}, 2ç€: ${winners.second}, 3ç€: ${winners.third}\n\nã“ã®å†…å®¹ã§ã€Œæœªæ‰•æˆ»ã€ã®é¦¬åˆ¸ã‚’å…¨ã¦ã‚¹ã‚­ãƒ£ãƒ³ã—ã€æ‰•ã„æˆ»ã—ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
                return;
            }
            payoutStatusMessage.textContent = "æ‰•ã„æˆ»ã—å‡¦ç†ã‚’å®Ÿè¡Œä¸­...";
            executePayoutButton.disabled = true;
            try {
                // 1. æ‰•ã„æˆ»ã—çµæœã‚’ "results" ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ä¿å­˜
                const resultsDocRef = db.collection("results").doc(raceName);
                const resultsData = {
                    race: raceName, winners: winners, odds: odds, processedAt: new Date()
                };
                await resultsDocRef.set(resultsData); // çµæœã‚’ä¸Šæ›¸ãä¿å­˜
                
                // 2. å¯¾è±¡ã®é¦¬åˆ¸ã‚’ã™ã¹ã¦å–å¾—
                const querySnapshot = await db.collection("bets")
                    .where("race", "==", raceName)
                    .where("paid", "==", false)
                    .get();
                if (querySnapshot.empty) {
                    payoutStatusMessage.textContent = `ã€Œ${raceName}ã€ã®æœªæ‰•æˆ»é¦¬åˆ¸ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚(çµæœã¯ä¿å­˜ã•ã‚Œã¾ã—ãŸ)`;
                    executePayoutButton.disabled = false; return;
                }
                // 3. ãƒãƒƒãƒå‡¦ç†ã®æº–å‚™
                const batch = db.batch();
                let totalPayout = 0; let winnerCount = 0;
                // 4. å…¨ã¦ã®æœªæ‰•æˆ»é¦¬åˆ¸ã‚’ãƒ«ãƒ¼ãƒ—ã—ã¦ãƒã‚§ãƒƒã‚¯
                querySnapshot.forEach((doc) => {
                    const bet = doc.data(); 
                    const betRef = doc.ref; 
                    const isWinner = checkWinner(bet, winners); 
                    if (isWinner) {
                        winnerCount++;
                        if (!odds[bet.type]) {
                            console.warn(`é…å½“ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„é¦¬åˆ¸ç¨®é¡ã§ã™: ${bet.type}`);
                            batch.update(betRef, { paid: true }); 
                        } else {
                            const payoutAmount = bet.amount * odds[bet.type];
                            totalPayout += payoutAmount;
                            const teamRef = db.collection("teams").doc(bet.team);
                            // (ãƒã‚°ä¿®æ­£) increment ãŒæ­£ã—ãä½¿ã‚ã‚Œã‚‹
                            batch.update(teamRef, { points: increment(payoutAmount) }); 
                            batch.update(betRef, { paid: true });
                        }
                    } else {
                        batch.update(betRef, { paid: true }); 
                    }
                });
                // 5. æº–å‚™ã—ãŸãƒãƒƒãƒå‡¦ç†ï¼ˆæ›´æ–°ï¼‰ã‚’ã€ã¾ã¨ã‚ã¦å®Ÿè¡Œï¼
                await batch.commit();
                payoutStatusMessage.textContent = `ã€Œ${raceName}ã€ã®æ‰•ã„æˆ»ã—ãŒå®Œäº†ã—ã¾ã—ãŸã€‚\n${querySnapshot.size}ä»¶ã®é¦¬åˆ¸ã‚’å‡¦ç†ã—ã€${winnerCount}ä»¶ãŒçš„ä¸­ã€‚\nåˆè¨ˆ ${totalPayout} pt ã®æ‰•ã„æˆ»ã—ã‚’è¡Œã„ã¾ã—ãŸã€‚`;
                executePayoutButton.disabled = false;
                payoutRaceName.value = ""; 
            } catch (error) {
                console.error("æ‰•ã„æˆ»ã—å‡¦ç†ã‚¨ãƒ©ãƒ¼:", error);
                payoutStatusMessage.textContent = `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`;
                alert(`æ‰•ã„æˆ»ã—ãƒãƒƒãƒå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
                executePayoutButton.disabled = false;
            }
        });
        
        // çš„ä¸­åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ (ã‚¹ãƒ†ãƒƒãƒ—17ã®ã‚³ãƒ¼ãƒ‰)
        function checkWinner(bet, winners) {
            const betHorses = bet.horses; const w = winners;
            try {
                switch (bet.type) {
                    case "Tansho": return betHorses[0] === w.first;
                    case "Nirentan": return betHorses[0] === w.first && betHorses[1] === w.second;
                    case "Nirenfuku": const winPair = [w.first, w.second]; return winPair.includes(betHorses[0]) && winPair.includes(betHorses[1]);
                    case "Sanrenpuku": const winTrio = [w.first, w.second, w.third]; return winTrio.includes(betHorses[0]) && winTrio.includes(betHorses[1]) && winTrio.includes(betHorses[2]);
                    case "Sanrentan": return betHorses[0] === w.first && betHorses[1] === w.second && betHorses[2] === w.third;
                    default: return false;
                }
            } catch (e) { return false; }
        }

        // ãƒ¬ãƒ¼ã‚¹åï¼ˆæ—¥æœ¬èªï¼‰ã‹ã‚‰IDï¼ˆè‹±æ•°ï¼‰ã«å¤‰æ›ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function getRaceIdFromName(raceName) {
            if (raceName === "ãƒ¬ãƒ¼ã‚¹0") return "race0";
            if (raceName === "ãƒ¬ãƒ¼ã‚¹1") return "race1";
            if (raceName === "ãƒ¬ãƒ¼ã‚¹2") return "race2";
            if (raceName === "ãƒ¬ãƒ¼ã‚¹3") return "race3";
            return null; // è©²å½“ãªã—
        }

        // -------------------------------------
        // åˆæœŸè¡¨ç¤º
        // -------------------------------------
        updateView(); // æœ€åˆã«ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’è¡¨ç¤º

    </script>

</body>
</html>
